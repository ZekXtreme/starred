name: Backup and Reset Repo History (CLI)

on:
  workflow_dispatch: # manual trigger only

jobs:
  backup-and-reset:
    runs-on: ubuntu-latest

    steps:
      # Checkout full history
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Configure Git
      - name: Git config
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

      # Install GitHub CLI
      - name: Install GH CLI
        run: |
          sudo apt update
          sudo apt install -y gh

      # Create a full history bundle
      - name: Create history bundle
        run: |
          BUNDLE_FILE="history-$(date +%F).bundle"
          git bundle create "$BUNDLE_FILE" --all
          echo "BUNDLE_FILE=$BUNDLE_FILE" >> $GITHUB_ENV
          gzip -c "$BUNDLE_FILE" > "$BUNDLE_FILE.gz"
          echo "BUNDLE_FILE_GZ=${BUNDLE_FILE}.gz" >> $GITHUB_ENV

      # Create GitHub Release and upload bundle
      - name: Upload release via GH CLI
        run: |
          TAG_NAME="backup-$(date +%F)"
          gh release create "$TAG_NAME" "$BUNDLE_FILE_GZ" \
            --title "Repo Backup $(date +%F)" \
            --notes "Full history backup"
        env:
          GITHUB_TOKEN: ${{ github.token }}

      # Reset main branch to clean orphan commit
      - name: Reset main branch
        run: |
          git checkout --orphan main
          git rm -rf .
          echo "# Repo Reset on $(date)" > README.md
          git add README.md
          git commit -m "Reset repository history"
          git push --force origin main
